import { expect, test } from './e2e/helpers/fixtures'

const SCREENSHOTS_PATH = './_bmad-output/implementation-artifacts/screenshots/story-6.1'

test.describe('Story 6.1 - AccessDeniedToast Desk Check', () => {

  test('Desktop - AccessDeniedToast appears on dashboard with error param', async ({ authenticatedPage }) => {
    // Set desktop viewport
    await authenticatedPage.setViewportSize({ width: 1280, height: 720 })

    // Set up console error listener BEFORE navigation
    const consoleErrors: string[] = []
    authenticatedPage.on('console', msg => {
      if (msg.type() === 'error' && !msg.text().includes('Sidecar')) {
        consoleErrors.push(msg.text())
      }
    })

    // Navigate to dashboard with error param
    await authenticatedPage.goto('/en/dashboard?error=access_denied')

    // Wait for page to load
    await authenticatedPage.waitForLoadState('domcontentloaded')

    // Take multiple screenshots at different times to catch the toast
    for (let i = 0; i < 4; i++) {
      await authenticatedPage.waitForTimeout(250)
      await authenticatedPage.screenshot({
        path: `${SCREENSHOTS_PATH}/desktop-access-denied-t${i}.png`,
        fullPage: true
      })
    }

    // Final screenshot after longer delay
    await authenticatedPage.waitForTimeout(500)
    await authenticatedPage.screenshot({
      path: `${SCREENSHOTS_PATH}/desktop-dashboard-access-denied.png`,
      fullPage: true
    })

    // Verify toast element exists or existed
    const toast = authenticatedPage.locator('[data-state="open"], [data-radix-collection-item], .group.pointer-events-auto')
    const toastCount = await toast.count()
    console.log(`Toast elements found: ${toastCount}`)

    // Log any console errors found
    if (consoleErrors.length > 0) {
      console.log('Console errors:', consoleErrors)
    }
  })

  test('Mobile - AccessDeniedToast appears on dashboard with error param', async ({ authenticatedPage }) => {
    // Set mobile viewport
    await authenticatedPage.setViewportSize({ width: 375, height: 667 })

    // Set up console error listener BEFORE navigation
    const consoleErrors: string[] = []
    authenticatedPage.on('console', msg => {
      if (msg.type() === 'error' && !msg.text().includes('Sidecar')) {
        consoleErrors.push(msg.text())
      }
    })

    // Navigate to dashboard with error param
    await authenticatedPage.goto('/en/dashboard?error=access_denied')

    // Wait for page to load
    await authenticatedPage.waitForLoadState('domcontentloaded')

    // Take multiple screenshots at different times to catch the toast
    for (let i = 0; i < 4; i++) {
      await authenticatedPage.waitForTimeout(250)
      await authenticatedPage.screenshot({
        path: `${SCREENSHOTS_PATH}/mobile-access-denied-t${i}.png`,
        fullPage: true
      })
    }

    // Final screenshot after longer delay
    await authenticatedPage.waitForTimeout(500)
    await authenticatedPage.screenshot({
      path: `${SCREENSHOTS_PATH}/mobile-dashboard-access-denied.png`,
      fullPage: true
    })

    // Log any console errors found
    if (consoleErrors.length > 0) {
      console.log('Console errors:', consoleErrors)
    }
  })

  test('Desktop - Dashboard without error param (baseline)', async ({ authenticatedPage }) => {
    // Set desktop viewport
    await authenticatedPage.setViewportSize({ width: 1280, height: 720 })

    // Navigate to dashboard without error param
    await authenticatedPage.goto('/en/dashboard')

    // Wait for page to load
    await authenticatedPage.waitForLoadState('domcontentloaded')
    await authenticatedPage.waitForTimeout(500)

    // Take screenshot
    await authenticatedPage.screenshot({
      path: `${SCREENSHOTS_PATH}/desktop-dashboard-baseline.png`,
      fullPage: false
    })
  })
})
